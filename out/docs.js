"use strict";
function generateFontSizeCssVars(start, sizes) {
    if (start === void 0) { start = 12; }
    if (sizes === void 0) { sizes = SIZES; }
    var fontSizes = [start];
    for (var i = 1; i < sizes.length; i++) {
        var desiredFontSize = Math.ceil(fontSizes[fontSizes.length - 1] * 1.25); // NOTE: derived from how monkeys count
        while ((desiredFontSize % 2) !== 0)
            desiredFontSize++; // NOTE: prevent fractional pixels
        fontSizes.push(desiredFontSize);
    }
    var acc = "  /* generated by generateFontSizeCssVars */";
    for (var i = 0; i < sizes.length; i++) {
        var sizeName = sizes[i];
        var fontSize = fontSizes[i];
        acc += "\n  --size-".concat(sizeName, ": ").concat(fontSize, "px;");
        for (var offset = 1; offset < sizes.length; offset++) {
            var j = Math.max(0, i - offset);
            acc += "\n  --size-".concat(sizeName, "-").concat(offset, ": var(--size-").concat(sizes[j], ");");
        }
    }
    return acc;
}
function generateColorCssVars(colors, start, step, shades) {
    if (colors === void 0) { colors = BASE_COLORS; }
    if (start === void 0) { start = 0.874; }
    if (step === void 0) { step = 2; }
    if (shades === void 0) { shades = COLOR_SHADES; }
    var acc = "  /* generated by generateColorCssVars */";
    for (var _i = 0, _a = Object.entries(colors); _i < _a.length; _i++) {
        var _b = _a[_i], colorName = _b[0], color = _b[1];
        for (var i = 0; i < shades.length; i++) {
            var shadeName = shades[i];
            var shadeSuffix = shadeName ? "-".concat(shadeName) : "";
            var shadeNumber = +"".concat((shadeName || "0")[0], ".").concat(shadeName.slice(1));
            var alpha = start / Math.pow(step, shadeNumber);
            acc += "\n  --".concat(colorName).concat(shadeSuffix, ": rgba(").concat(color, ", ").concat(alpha.toFixed(3), ");");
        }
    }
    return acc;
}
setTimeout(function () {
    //console.log(generateFontSizeCssVars());
    console.log(generateColorCssVars());
});
var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        if (typeof b !== "function" && b !== null)
            throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
// TODO: make a typescript compiler to compile packages like odin
var JSGUI_VERSION = "v0.3-dev";
// utils
function parseJsonOrNull(jsonString) {
    try {
        return JSON.parse(jsonString);
    }
    catch (_a) {
        return null;
    }
}
function camelCaseToKebabCase(key) {
    var _a;
    return ((_a = key.match(/[A-Z][a-z]*|[a-z]+/g)) !== null && _a !== void 0 ? _a : []).map(function (v) { return v.toLowerCase(); }).join("-");
}
function addPx(value) {
    var _a;
    return (((_a = value === null || value === void 0 ? void 0 : value.constructor) === null || _a === void 0 ? void 0 : _a.name) === "Number") ? "".concat(value, "px") : value;
}
var Component = /** @class */ (function () {
    function Component(onRender, args, baseProps, props, options) {
        var _a;
        this.name = (_a = options.name) !== null && _a !== void 0 ? _a : onRender.name;
        if (!this.name && (options.name !== ""))
            throw "Function name cannot be empty: ".concat(onRender);
        this.args = args;
        this.baseProps = baseProps;
        this.props = props;
        this.children = [];
        this.onRender = onRender;
        this.options = options;
        this._ = null;
        this._indexedChildCount = 0;
        this._usedKeys = new Set();
        this._mediaKeys = [];
    }
    Component.prototype.append = function (child) {
        this.children.push(child);
        return child;
    };
    Component.prototype.useState = function (defaultState) {
        var _ = this._;
        if (!_.stateIsInitialized) {
            _.state = defaultState;
            _.stateIsInitialized = true;
        }
        return _.state;
    };
    Component.prototype.useValidate = function (getErrors) {
        var _this = this;
        return function () {
            var errors = {};
            getErrors(errors);
            var state = _this._.state;
            state.errors = errors;
            state.didValidate = true;
            var hasErrors = Object.keys(errors).length > 0;
            if (hasErrors) {
                _this.rerender();
            }
            return !hasErrors;
        };
    };
    Component.prototype.useMedia = function (mediaQuery) {
        var key = Object.entries(mediaQuery).map(function (_a) {
            var k = _a[0], v = _a[1];
            return "(".concat(camelCaseToKebabCase(k), ": ").concat(addPx(v), ")");
        }).join(' and ');
        this._mediaKeys.push(key);
        var dispatchTarget = DispatchTarget.init(key, _mediaQueryDispatchTargets, function (dispatch) {
            var mediaQueryList = window.matchMedia(key);
            mediaQueryList.addEventListener("change", dispatch);
            return mediaQueryList;
        });
        dispatchTarget.addComponent(this);
        return dispatchTarget.state.matches;
    };
    Component.prototype.useLocalStorage = function (key, defaultValue) {
        var _a, _b;
        _localStorageDispatchTarget.addComponent(this);
        var value = (_b = (_a = parseJsonOrNull(localStorage[key])) === null || _a === void 0 ? void 0 : _a[0]) !== null && _b !== void 0 ? _b : defaultValue;
        var setValue = function (newValue) {
            localStorage.setItem(key, JSON.stringify([newValue]));
        };
        return [value, setValue];
    };
    Component.prototype.useNavigate = function () {
        return {
            navigate: function (url) { return location.href = url; },
            replace: function (url) { return location.replace(url); },
        };
    };
    Component.prototype.rerender = function () {
        var root_ = this._.root;
        var rootComponent = root_.component;
        var newGcFlag = !root_.gcFlag;
        if (!root_.willRerenderNextFrame) {
            root_.willRerenderNextFrame = true;
            requestAnimationFrame(function () {
                var newRootComponent = _copyComponent(rootComponent);
                newRootComponent._ = root_;
                root_.gcFlag = newGcFlag;
                root_.component = newRootComponent;
                _render(newRootComponent, root_.parentNode);
                _unloadUnusedComponents(rootComponent, newGcFlag);
                root_.willRerenderNextFrame = false;
            });
        }
    };
    return Component;
}());
function makeComponent(onRender, options) {
    if (options === void 0) { options = {}; }
    return function () {
        var _a;
        var argsOrProps = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            argsOrProps[_i] = arguments[_i];
        }
        var argCount = Math.max(0, onRender.length - 1);
        var args = argsOrProps.slice(0, argCount);
        var propsAndBaseProps = ((_a = argsOrProps[argCount]) !== null && _a !== void 0 ? _a : {});
        var key = propsAndBaseProps.key, style = propsAndBaseProps.style, attribute = propsAndBaseProps.attribute, className = propsAndBaseProps.className, cssVars = propsAndBaseProps.cssVars, props = __rest(propsAndBaseProps, ["key", "style", "attribute", "className", "cssVars"]);
        var baseProps = { key: (key != null) ? String(key) : undefined, style: style, attribute: attribute, className: className, cssVars: cssVars };
        return new Component(onRender, args, baseProps, props, options);
    };
}
function _copyComponent(component) {
    var newComponent = new Component(component.onRender, component.args, component.baseProps, component.props, component.options);
    newComponent._ = component._;
    return newComponent;
}
var DispatchTarget = /** @class */ (function () {
    function DispatchTarget(addListeners) {
        var _this = this;
        this.components = [];
        this.state = addListeners(function () { return _this.dispatch(); });
    }
    DispatchTarget.init = function (key, store, addListeners) {
        var oldDT = store[key];
        if (oldDT != null)
            return oldDT;
        var newDT = new DispatchTarget(addListeners);
        store[key] = newDT;
        return newDT;
    };
    DispatchTarget.prototype.addComponent = function (component) {
        this.components.push(component);
    };
    DispatchTarget.prototype.removeComponent = function (component) {
        var i = this.components.indexOf(component);
        if (i !== -1)
            this.components.splice(i, 1);
    };
    DispatchTarget.prototype.dispatch = function () {
        for (var _i = 0, _a = this.components; _i < _a.length; _i++) {
            var component = _a[_i];
            component.rerender();
        }
    };
    return DispatchTarget;
}());
var _mediaQueryDispatchTargets = {};
var _localStorageDispatchTarget = new DispatchTarget(function (dispatch) { return window.addEventListener("storage", dispatch); });
function _scrollToLocationHash() {
    var element = document.getElementById(location.hash.slice(1));
    if (element)
        element.scrollIntoView();
}
var _locationHashDispatchTarget = new DispatchTarget(function (dispatch) {
    window.addEventListener("hashchange", function () {
        _scrollToLocationHash();
        dispatch();
    });
});
var ComponentMetadata = /** @class */ (function () {
    function ComponentMetadata(parent) {
        var _a;
        // state
        this.stateIsInitialized = false;
        this.state = {};
        this.prevState = null;
        this.prevNode = null;
        this.gcFlag = false;
        // navigation
        this.prevComponent = null;
        this.keyToChild = {};
        this.prevIndexedChildCount = null;
        this.parent = parent;
        this.root = (_a = parent === null || parent === void 0 ? void 0 : parent.root) !== null && _a !== void 0 ? _a : null;
    }
    return ComponentMetadata;
}());
var RootComponentMetadata = /** @class */ (function (_super) {
    __extends(RootComponentMetadata, _super);
    function RootComponentMetadata(component, parentNode) {
        var _this = _super.call(this, null) || this;
        _this.willRerenderNextFrame = false;
        _this.root = _this;
        _this.component = component;
        _this.parentNode = parentNode;
        return _this;
    }
    return RootComponentMetadata;
}(ComponentMetadata));
// render
function renderRoot(component, parentNode) {
    if (parentNode === void 0) { parentNode = null; }
    var root_ = new RootComponentMetadata(component, parentNode);
    component._ = root_;
    window.onload = function () {
        var _a;
        root_.parentNode = (_a = root_.parentNode) !== null && _a !== void 0 ? _a : document.body;
        _render(component, root_.parentNode);
        setTimeout(function () {
            _scrollToLocationHash();
        });
    };
}
var _START_BASE_PROPS = {
    attribute: {},
    className: [],
    cssVars: {},
    style: {},
};
function _render(component, parentNode, _inheritedBaseProps, isTopNode) {
    var _a;
    if (_inheritedBaseProps === void 0) { _inheritedBaseProps = _START_BASE_PROPS; }
    if (isTopNode === void 0) { isTopNode = true; }
    // render elements
    var _ = component._, name = component.name, args = component.args, baseProps = component.baseProps, props = component.props, onRender = component.onRender, options = component.options, _indexedChildCount = component._indexedChildCount;
    var onMount = options.onMount;
    var node = onRender.bind(component).apply(void 0, __spreadArray(__spreadArray([], args, false), [props], false));
    if (!(node instanceof Element))
        node = undefined;
    // set prev state
    var prevIndexedChildCount = _.prevIndexedChildCount;
    if (prevIndexedChildCount !== null && (_indexedChildCount !== prevIndexedChildCount)) {
        console.warn("Varying children should have a \"key\" prop. (".concat(prevIndexedChildCount, " -> ").concat(_indexedChildCount, ")"), _.prevComponent, component);
    }
    _.prevIndexedChildCount = _indexedChildCount;
    _.prevState = __assign({}, _.state);
    _.prevComponent = component;
    // append element
    var _className = baseProps.className;
    var inheritedBaseProps = {
        attribute: __assign(__assign({}, _inheritedBaseProps.attribute), baseProps.attribute),
        className: __spreadArray([], _inheritedBaseProps.className, true),
        cssVars: __assign(__assign({}, _inheritedBaseProps.cssVars), baseProps.cssVars),
        style: __assign(__assign({}, _inheritedBaseProps.style), baseProps.style),
    };
    if (Array.isArray(_className)) {
        inheritedBaseProps.className = __spreadArray(__spreadArray([], inheritedBaseProps.className, true), _className, true);
    }
    else if (_className) {
        inheritedBaseProps.className = __spreadArray(__spreadArray([], inheritedBaseProps.className, true), _className.split(" "), true);
    }
    if (node) {
        // style
        for (var _i = 0, _b = Object.entries(inheritedBaseProps.style); _i < _b.length; _i++) {
            var _c = _b[_i], k = _c[0], v = _c[1];
            if (v != null) {
                node.style[k] = addPx(v);
            }
        }
        // cssVars
        for (var _d = 0, _e = Object.entries(inheritedBaseProps.cssVars); _d < _e.length; _d++) {
            var _f = _e[_d], k = _f[0], v = _f[1];
            if (v != null) {
                node.style.setProperty("--".concat(k), addPx(v));
            }
        }
        // class
        if (name !== node.tagName.toLowerCase()) {
            inheritedBaseProps.className.push(name);
        }
        ;
        for (var _g = 0, _h = inheritedBaseProps.className; _g < _h.length; _g++) {
            var v = _h[_g];
            if (!v)
                console.warn("Empty className", name, inheritedBaseProps.className);
            node.classList.add(v);
        }
        // attribute
        for (var _j = 0, _k = Object.entries(inheritedBaseProps.attribute); _j < _k.length; _j++) {
            var _l = _k[_j], k = _l[0], v = _l[1];
            node.setAttribute(camelCaseToKebabCase(k), String(v));
        }
        // append
        var prevNode = _.prevNode;
        if (isTopNode && prevNode) {
            prevNode.replaceWith(node);
        }
        else {
            parentNode.append(node);
        }
        if (onMount)
            onMount(component, node);
        _.prevNode = node;
        // inherit
        parentNode = node;
        isTopNode = false;
        inheritedBaseProps = _START_BASE_PROPS;
    }
    else {
        if (name)
            inheritedBaseProps.className.push(name); // NOTE: fragment has name: ''
    }
    // children
    var usedKeys = new Set();
    for (var _m = 0, _o = component.children; _m < _o.length; _m++) {
        var child = _o[_m];
        var key = child.baseProps.key;
        if (key == null) {
            key = "".concat(child.name, "-").concat(component._indexedChildCount++);
        }
        if (usedKeys.has(key))
            console.warn("Duplicate key: '".concat(key, "'"), component);
        usedKeys.add(key);
        var child_ = (_a = _.keyToChild[key]) !== null && _a !== void 0 ? _a : new ComponentMetadata(_);
        _.keyToChild[key] = child_;
        child._ = child_;
        child_.gcFlag = _.gcFlag;
        _render(child, parentNode, inheritedBaseProps, isTopNode);
    }
}
// rerender
function _unloadUnusedComponents(prevComponent, gcFlag) {
    var _a;
    for (var _i = 0, _b = prevComponent.children; _i < _b.length; _i++) {
        var child = _b[_i];
        var child_ = child._;
        if (child_.gcFlag !== gcFlag) {
            for (var _c = 0, _d = child._mediaKeys; _c < _d.length; _c++) {
                var key = _d[_c];
                _mediaQueryDispatchTargets[key].removeComponent(prevComponent);
            }
            _localStorageDispatchTarget.removeComponent(prevComponent);
            (_a = child_.parent) === null || _a === void 0 ? true : delete _a.keyToChild[child.baseProps.key];
        }
        _unloadUnusedComponents(child, gcFlag);
    }
}
// basic components
var fragment = makeComponent(function fragment(_props) {
    if (_props === void 0) { _props = {}; }
}, { name: '' });
var div = makeComponent(function div(_props) {
    if (_props === void 0) { _props = {}; }
    return document.createElement('div');
});
var SIZES = ["small", "normal", "big", "bigger"];
var BASE_COLORS = {
    gray: "0, 0, 0",
    secondary: "20, 80, 160",
    red: "200, 50, 50",
};
var COLOR_SHADES = ["", "033", "067", "1", "2", "3"];
var span = makeComponent(function _span(text, props) {
    var _this = this;
    if (props === void 0) { props = {}; }
    var iconName = props.iconName, size = props.size, color = props.color, singleLine = props.singleLine, fontFamily = props.fontFamily, href = props.href, replacePath = props.replacePath, selfLink = props.selfLink, onClick = props.onClick;
    if (selfLink) {
        var selfLinkWrapper = this.append(div({ className: "selfLink", attribute: { id: selfLink } }));
        selfLinkWrapper.append(span(text, __assign(__assign({}, props), { selfLink: undefined })));
        selfLinkWrapper.append(icon("tag", { size: "normal", href: "#".concat(selfLink) }));
        return;
    }
    var isLink = (href != null);
    var e = document.createElement(isLink ? 'a' : 'span');
    if (iconName) {
        e.classList.add("material-symbols-outlined");
        if (size)
            e.style.fontSize = "calc(1.25 * var(--size-".concat(size, "))");
    }
    else {
        if (size)
            e.style.fontSize = "var(--size-".concat(size, ")");
    }
    if (color)
        e.style.color = "var(--".concat(color, ")");
    if (singleLine) {
        e.style.overflow = "hidden";
        e.style.textOverflow = "ellipsis";
        e.style.whiteSpace = "nowrap";
    }
    if (fontFamily)
        e.style.fontFamily = "var(--fontFamily-".concat(fontFamily, ")");
    if (isLink) {
        e.href = href;
        if (replacePath) {
            e.onclick = function (event) {
                event.preventDefault();
                _this.useNavigate().replace(href);
                if (onClick)
                    onClick(event);
            };
        }
    }
    else {
        if (onClick) {
            e.onclick = onClick;
            e.setAttribute("tabindex", "-1");
            e.setAttribute("clickable", "true");
        }
    }
    e.innerText = iconName || (text == null ? "" : String(text));
    return e;
}, { name: "span" });
var icon = makeComponent(function icon(iconName, props) {
    if (props === void 0) { props = {}; }
    var size = props.size, _a = props.style, style = _a === void 0 ? {} : _a, extraProps = __rest(props, ["size", "style"]);
    this.append(span("", __assign({ iconName: iconName, size: size, style: style }, extraProps)));
});
var loadingSpinner = makeComponent(function loadingSpinner(props) {
    if (props === void 0) { props = {}; }
    this.append(icon("progress_activity", props));
});
var button = makeComponent(function button(text, props) {
    if (props === void 0) { props = {}; }
    var size = props.size, color = props.color, onClick = props.onClick, disabled = props.disabled;
    var e = document.createElement("button");
    e.innerText = text;
    if (size)
        e.style.fontSize = "var(--size-".concat(size !== null && size !== void 0 ? size : "normal", ")");
    if (color) {
        e.style.setProperty("--buttonColor", "var(--".concat(color, ")"));
        e.style.setProperty("--buttonColorHover", "var(--".concat(color, "-033)"));
        e.style.setProperty("--buttonColorActive", "var(--".concat(color, "-067)"));
    }
    if (disabled)
        e.setAttribute("disabled", "true");
    else if (onClick)
        e.onclick = onClick;
    return e;
});
var input = makeComponent(function input(props) {
    var _a, _b;
    var _c = props.type, type = _c === void 0 ? "text" : _c, placeholder = props.placeholder, value = props.value, autoFocus = props.autoFocus, onFocus = props.onFocus, onBlur = props.onBlur, onKeyDown = props.onKeyDown, onInput = props.onInput, onChange = props.onChange, allowChar = props.allowChar, _d = props.allowString, allowString = _d === void 0 ? function (value, _prevAllowedValue) { return value; } : _d;
    var state = this.useState({ prevAllowedValue: String(value !== null && value !== void 0 ? value : ''), needFocus: false });
    var e = ((_b = (_a = this._) === null || _a === void 0 ? void 0 : _a.prevNode) !== null && _b !== void 0 ? _b : document.createElement('input')); // NOTE: e.remove() must not be called
    e.type = type;
    if (placeholder)
        e.placeholder = placeholder;
    if (autoFocus)
        e.autofocus = true;
    if (value != null)
        e.value = String(value);
    e.onfocus = function (event) {
        if (onFocus)
            onFocus(event);
    };
    e.onblur = function (event) {
        if (onBlur)
            onBlur(event);
    };
    e.onkeydown = function (event) {
        if (onKeyDown)
            onKeyDown(event);
        state.needFocus = true;
    };
    e.oninput = function (_event) {
        var event = _event;
        if (allowChar && "data" in event) {
            if ((event.data !== null) && !allowChar(event.data)) {
                event.preventDefault();
                event.stopPropagation();
                e.value = state.prevAllowedValue;
                return;
            }
        }
        var allowedValue = allowString(e.value, state.prevAllowedValue);
        state.prevAllowedValue = allowedValue;
        state.needFocus = true;
        if (allowedValue === e.value) {
            if (onInput)
                onInput(allowedValue, event);
        }
    };
    e.onchange = function (_event) {
        var event = _event;
        var allowedValue = allowString(e.value, state.prevAllowedValue);
        state.prevAllowedValue = allowedValue;
        if (e.value === allowedValue) {
            if (onChange)
                onChange(e.value, event);
        }
        else {
            e.value = allowedValue;
        }
    };
    return e;
}, {
    onMount: function (component, e) {
        var state = component._.state;
        if (state.needFocus) {
            e.focus();
            state.needFocus = false;
        }
    },
});
var labeledInput = makeComponent(function labeledInput(props) {
    var _a = props.label, label = _a === void 0 ? "" : _a, leftComponent = props.leftComponent, inputComponent = props.inputComponent, rightComponent = props.rightComponent;
    var fieldset = document.createElement("fieldset");
    fieldset.onmousedown = function (event) {
        if (event.target !== inputComponent._.prevNode) {
            event.preventDefault();
        }
    };
    fieldset.onclick = function (event) {
        var prevNode = inputComponent._.prevNode;
        if (prevNode && (event.target !== prevNode)) {
            prevNode.focus();
        }
    };
    var legend = document.createElement("legend");
    legend.innerText = label;
    fieldset.append(legend);
    if (leftComponent)
        this.append(leftComponent);
    this.append(inputComponent);
    if (rightComponent)
        this.append(rightComponent);
    return fieldset;
});
var errorMessage = makeComponent(function errorMessage(error, props) {
    if (props === void 0) { props = {}; }
    this.append(span(error, __assign({ color: "red", size: "small" }, props)));
});
var textInput = makeComponent(function textInput(props) {
    var label = props.label, leftComponent = props.leftComponent, rightComponent = props.rightComponent, error = props.error, extraProps = __rest(props, ["label", "leftComponent", "rightComponent", "error"]);
    this.append(labeledInput({
        label: label,
        leftComponent: leftComponent,
        inputComponent: input(extraProps),
        rightComponent: rightComponent,
    }));
    if (error)
        this.append(errorMessage(error));
});
var numberArrows = makeComponent(function numberArrows(props) {
    if (props === void 0) { props = {}; }
    var onClickUp = props.onClickUp, onClickDown = props.onClickDown;
    var wrapper = this.append(div());
    wrapper.append(icon("arrow_drop_up", { className: "upIcon", onClick: onClickUp }));
    wrapper.append(icon("arrow_drop_down", { className: "downIcon", onClick: onClickDown }));
});
var numberInput = makeComponent(function numberInput(props) {
    var label = props.label, leftComponent = props.leftComponent, customRightComponent = props.rightComponent, error = props.error, // labeledInput
    value = props.value, min = props.min, max = props.max, step = props.step, stepPrecision = props.stepPrecision, _a = props.clearable, clearable = _a === void 0 ? true : _a, onKeyDown = props.onKeyDown, onInput = props.onInput, onChange = props.onChange, extraProps = __rest(props, ["label", "leftComponent", "rightComponent", "error", "value", "min", "max", "step", "stepPrecision", "clearable", "onKeyDown", "onInput", "onChange"]) // numberInput
    ;
    var stepAndClamp = function (number) {
        var _a;
        if (step) {
            var stepOffset = (_a = min !== null && min !== void 0 ? min : max) !== null && _a !== void 0 ? _a : 0;
            number = stepOffset + Math.round((number - stepOffset) / step) * step;
        }
        number = Math.min(number, max !== null && max !== void 0 ? max : 1 / 0);
        number = Math.max(min !== null && min !== void 0 ? min : -1 / 0, number);
        var defaultStepPrecision = step ? String(step).split(".")[1].length : 0;
        return number.toFixed(stepPrecision !== null && stepPrecision !== void 0 ? stepPrecision : defaultStepPrecision);
    };
    var incrementValue = function (by) {
        var number = stepAndClamp(+(value !== null && value !== void 0 ? value : 0) + by);
        var newValue = String(number);
        if (onInput)
            onInput(newValue, undefined);
        if (onChange)
            onChange(newValue, undefined);
    };
    var inputComponent = input(__assign(__assign({ value: value, onKeyDown: function (event) {
            switch (event.key) {
                case "ArrowUp":
                    incrementValue(step !== null && step !== void 0 ? step : 1);
                    break;
                case "ArrowDown":
                    incrementValue(-(step !== null && step !== void 0 ? step : 1));
                    break;
            }
            if (onKeyDown)
                onKeyDown(event);
        }, onInput: onInput, onChange: onChange }, extraProps), { allowChar: function (c) { return "-0123456789".includes(c); }, allowString: function (value, prevAllowedValue) {
            if (value === "")
                return clearable ? "" : prevAllowedValue;
            var number = +value;
            if (isNaN(number))
                return prevAllowedValue;
            return String(stepAndClamp(number));
        } }));
    var rightComponent = fragment();
    if (customRightComponent)
        rightComponent.append(customRightComponent);
    rightComponent.append(numberArrows({
        onClickUp: function (_event) {
            incrementValue(step !== null && step !== void 0 ? step : 1);
            inputComponent._.state.needFocus = true;
            inputComponent.rerender();
        },
        onClickDown: function (_event) {
            incrementValue(-(step !== null && step !== void 0 ? step : 1));
            inputComponent._.state.needFocus = true;
            inputComponent.rerender();
        },
    }));
    this.append(labeledInput({
        label: label,
        leftComponent: leftComponent,
        inputComponent: inputComponent,
        rightComponent: rightComponent,
    }));
    if (error)
        this.append(errorMessage(error));
});
var table = makeComponent(function table(props) {
    // TODO: set minHeight to fit N rows
    // TODO: actions, filters, search, paging, selection
    var label = props.label, _a = props.columns, columns = _a === void 0 ? [] : _a, _b = props.rows, rows = _b === void 0 ? [] : _b, _c = props.isLoading, isLoading = _c === void 0 ? false : _c, _d = props.minHeight, minHeight = _d === void 0 ? 400 : _d, _e = props.useMaxHeight, useMaxHeight = _e === void 0 ? false : _e;
    var tableWrapper = this.append(div({
        attribute: { useMaxHeight: useMaxHeight, isLoading: isLoading },
        style: { minHeight: minHeight },
    }));
    var makeRow = function (className) { return div({ className: className }); };
    var makeCell = function (column) {
        var _a;
        return div({
            className: "tableCell",
            style: { flex: String((_a = column.flex) !== null && _a !== void 0 ? _a : 1), minWidth: column.minWidth, maxWidth: column.maxWidth },
        });
    };
    if (label) {
        tableWrapper.append(span(label, { className: "tableLabel" }));
    }
    if (isLoading) {
        tableWrapper.append(loadingSpinner());
    }
    else {
        var headerWrapper = tableWrapper.append(makeRow("tableRow tableHeader"));
        for (var columnIndex = 0; columnIndex < columns.length; columnIndex++) {
            var column = columns[columnIndex];
            var cellWrapper = headerWrapper.append(makeCell(column));
            cellWrapper.append(span(column.label));
        }
        for (var rowIndex = 0; rowIndex < rows.length; rowIndex++) {
            var row = rows[rowIndex];
            var rowWrapper = tableWrapper.append(makeRow("tableRow tableBody"));
            for (var columnIndex = 0; columnIndex < columns.length; columnIndex++) {
                var column = columns[columnIndex];
                var cellWrapper = rowWrapper.append(makeCell(column));
                cellWrapper.append(column.onRender({ row: row, rowIndex: rowIndex, column: column, columnIndex: columnIndex }));
            }
        }
    }
});
var router = makeComponent(function router(props) {
    var _a, _b, _c;
    var routes = props.routes, _d = props.pageWrapperComponent, pageWrapperComponent = _d === void 0 ? function () { return fragment(); } : _d, _e = props.contentWrapperComponent, contentWrapperComponent = _e === void 0 ? function () { return div({ className: "pageContent" }); } : _e, currentRoles = props.currentRoles, isLoggedIn = props.isLoggedIn, _f = props.notLoggedInRoute, notLoggedInRoute = _f === void 0 ? { component: fragment } : _f, _g = props.notFoundRoute, notFoundRoute = _g === void 0 ? { component: function () { return span("404 Not found"); } } : _g, _h = props.unauthorizedRoute, unauthorizedRoute = _h === void 0 ? { component: fragment } : _h;
    var currentPath = location.pathname;
    if (currentPath.endsWith("/index.html"))
        currentPath = currentPath.slice(0, -10);
    var currentRoute = null, params = {}; // TODO: save params in rootComponent?
    var _loop_1 = function (route) {
        var regex = route.path.replace(/:([^/]+)/g, function (_match, g1) { return "(?<".concat(g1, ">[^/]*)"); });
        var match = currentPath.match(new RegExp("^".concat(regex, "$")));
        if (match != null) {
            params = (_a = match.groups) !== null && _a !== void 0 ? _a : {};
            var roles_1 = (_b = route.roles) !== null && _b !== void 0 ? _b : [];
            var needSomeRole = (roles_1.length > 0);
            var haveSomeRole = (currentRoles !== null && currentRoles !== void 0 ? currentRoles : []).some(function (role) { return roles_1.includes(role); });
            if (!needSomeRole || haveSomeRole) {
                currentRoute = route;
            }
            else {
                currentRoute = __assign({ path: ".*" }, (isLoggedIn ? notLoggedInRoute : unauthorizedRoute));
            }
            return "break";
        }
    };
    for (var _i = 0, routes_1 = routes; _i < routes_1.length; _i++) {
        var route = routes_1[_i];
        var state_1 = _loop_1(route);
        if (state_1 === "break")
            break;
    }
    if (!currentRoute) {
        console.warn("Route '".concat(currentPath, "' not found."));
        currentRoute = __assign({ path: ".*" }, notFoundRoute);
    }
    if (currentRoute) {
        if ((_c = currentRoute.wrapper) !== null && _c !== void 0 ? _c : true) {
            this.append(pageWrapperComponent({ routes: routes, currentRoute: currentRoute, contentWrapperComponent: contentWrapperComponent }));
        }
        else {
            var contentWrapper = this.append(contentWrapperComponent());
            contentWrapper.append(currentRoute.component());
        }
    }
});
/*
TODO: documentation
  div({...})
  span(text)
  span(text, {href})
  icon(iconName)
  textInput({label, value})
  numberInput({label, value})
  loadingSpinner()
  router()
  validation api
    const validate = this.useValidate((errors) => {
      if (state.username.length < 4) errors.username = "Username must have at least 4 characters."
    });
    const onSubmit = () => {
      if (validate()) {
        // ...
      }
    }
  useState()
  useLocalStorage()
  useNavigate()
*/
// TODO: more input components (button, radio, checkbox/switch, select, date/date range input, file input)
// TODO: tooltips, badges, dialogs
// TODO: snackbar api
// TODO: https://developer.mozilla.org/en-US/docs/Web/API/Popover_API ?
// TODO: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/dialog ?
function getSizeLabel(size) {
    return size[0].toUpperCase() + size.slice(1);
}
var spanSection = makeComponent(function spanSection() {
    for (var _i = 0, _a = [undefined, "https://www.google.com"]; _i < _a.length; _i++) {
        var href = _a[_i];
        var row = this.append(div({ className: "displayRow" }));
        row.append(span("Small", { size: "small", href: href }));
        row.append(span("Normal", { size: "normal", href: href }));
        row.append(span("Big", { size: "big", href: href }));
        row.append(span("Bigger", { size: "bigger", href: href }));
    }
    for (var _b = 0, _c = Object.keys(BASE_COLORS); _b < _c.length; _b++) {
        var baseColor = _c[_b];
        var row = this.append(div({ className: "displayRow" }));
        for (var _d = 0, COLOR_SHADES_1 = COLOR_SHADES; _d < COLOR_SHADES_1.length; _d++) {
            var shade = COLOR_SHADES_1[_d];
            var color = shade ? "".concat(baseColor, "-").concat(shade) : baseColor;
            row.append(span(color, { color: color }));
        }
    }
});
var iconSection = makeComponent(function spanSection() {
    var row = this.append(div({ className: "displayRow" }));
    for (var _i = 0, SIZES_1 = SIZES; _i < SIZES_1.length; _i++) {
        var size = SIZES_1[_i];
        var itemWrapper = row.append(div());
        itemWrapper.append(span(getSizeLabel(size), { size: size }));
        itemWrapper.append(icon("link", { size: size }));
    }
    row = this.append(div({ className: "displayRow" }));
    for (var _a = 0, SIZES_2 = SIZES; _a < SIZES_2.length; _a++) {
        var size = SIZES_2[_a];
        row.append(icon("link", { size: size }));
    }
    row = this.append(div({ className: "displayRow" }));
    for (var _b = 0, SIZES_3 = SIZES; _b < SIZES_3.length; _b++) {
        var size = SIZES_3[_b];
        row.append(loadingSpinner({ size: size }));
    }
});
var textInputSection = makeComponent(function textInputSection() {
    var _this = this;
    var state = this.useState({ username: "" });
    // username
    var row = this.append(div({ className: "displayRow", style: { marginTop: 4 } }));
    row.append(textInput({
        label: "Username",
        value: state.username,
        onInput: function (newUsername) {
            state.username = newUsername;
            _this.rerender();
        },
        autoFocus: true,
    }));
    row.append(span("This input is stored in the component state."));
    row = this.append(div({ className: "displayRow", style: { marginTop: -4 } }));
    row.append(span("state: ".concat(JSON.stringify(state))));
    // count
    row = this.append(div({ className: "displayRow", style: { marginTop: 4 } }));
    var _a = this.useLocalStorage("count", 0), count = _a[0], setCount = _a[1];
    row.append(numberInput({
        label: "Count",
        value: count,
        onInput: function (newCount) {
            setCount(newCount === "" ? null : +newCount);
            _this.rerender();
        },
        min: 0,
        clearable: false,
    }));
    row.append(span("This input is stored in local storage (synced across tabs and components)."));
    row = this.append(div({ className: "displayRow", style: { marginTop: -4 } }));
    row.append(span("count: ".concat(count)));
});
var tableSection = makeComponent(function tableSection() {
    var count = this.useLocalStorage("count", 0)[0];
    var rows = Array(+(count !== null && count !== void 0 ? count : 0))
        .fill(0)
        .map(function (_, i) { return i; });
    this.append(table({
        label: "Stuff",
        rows: rows,
        columns: [
            {
                label: "#",
                onRender: function (props) { return span(props.rowIndex + 1); },
            },
            {
                label: "Name",
                onRender: function (props) { return span("foo ".concat(props.row)); },
            },
            {
                label: "Count",
                onRender: function (props) { return span(props.row); },
            },
        ],
    }));
    if ((count !== null && count !== void 0 ? count : 0) % 2 === 0) {
        this.append(testKeysComponent({ key: "testKeysComponent" }));
    }
});
var testKeysComponent = makeComponent(function testKeysComponent(_) {
    this.append(span(""));
});
var mediaQuerySection = makeComponent(function mediaQuerySection() {
    var smOrBigger = this.useMedia({ minWidth: 600 });
    var mdOrBigger = this.useMedia({ minWidth: 900 });
    var lgOrBigger = this.useMedia({ minWidth: 1200 });
    var xlOrBigger = this.useMedia({ minWidth: 1500 });
    this.append(span("smOrBigger: ".concat(smOrBigger)));
    this.append(span("mdOrBigger: ".concat(mdOrBigger)));
    this.append(span("lgOrBigger: ".concat(lgOrBigger)));
    this.append(span("xlOrBigger: ".concat(xlOrBigger)));
});
var buttonSection = makeComponent(function buttonSection() {
    var row = this.append(div({ className: "displayRow", style: { marginTop: 4 } }));
    for (var _i = 0, SIZES_4 = SIZES; _i < SIZES_4.length; _i++) {
        var size = SIZES_4[_i];
        row.append(button(getSizeLabel(size), { size: size }));
    }
    row = this.append(div({ className: "displayRow", style: { marginTop: 4 } }));
    for (var _a = 0, SIZES_5 = SIZES; _a < SIZES_5.length; _a++) {
        var size = SIZES_5[_a];
        row.append(button(getSizeLabel(size), { color: "secondary", size: size }));
    }
});
var MAIN_PAGE_SECTIONS = [
    {
        label: "Span",
        id: "span",
        component: spanSection,
    },
    {
        label: "Icon",
        id: "icon",
        component: iconSection,
    },
    {
        label: "Text input",
        id: "textInput",
        component: textInputSection,
    },
    {
        label: "Table",
        id: "table",
        component: tableSection,
    },
    {
        label: "Media query",
        id: "mediaQuery",
        component: mediaQuerySection,
    },
    {
        label: "Button",
        id: "button",
        component: buttonSection,
    },
];
var mainPage = makeComponent(function mainPage() {
    var wrapper = this.append(div({
        style: { display: "flex", flexDirection: "column", alignItems: "flex-start" },
    }));
    wrapper.append(span("version: ".concat(JSGUI_VERSION), { size: "small" }));
    for (var _i = 0, MAIN_PAGE_SECTIONS_1 = MAIN_PAGE_SECTIONS; _i < MAIN_PAGE_SECTIONS_1.length; _i++) {
        var section = MAIN_PAGE_SECTIONS_1[_i];
        wrapper.append(span(section.label, { size: "big", selfLink: section.id }));
        wrapper.append(section.component());
        // TODO!: show the code
    }
});
var notFoundPage = makeComponent(function notFoundPage() {
    this.append(span("Page not found"));
});
var root = makeComponent(function root() {
    var GITHUB_PAGES_PREFIX = "(/jsgui)?";
    this.append(router({
        pageWrapperComponent: pageWrapper,
        routes: [
            {
                path: "".concat(GITHUB_PAGES_PREFIX, "/"),
                component: function () { return mainPage(); },
                wrapper: true,
                showInNavigation: true,
                label: "jsgui",
            },
        ],
        notFoundRoute: {
            component: function () { return notFoundPage(); },
        },
    }));
});
var pageWrapper = makeComponent(function pageWrapper(props) {
    var routes = props.routes, currentRoute = props.currentRoute, contentWrapperComponent = props.contentWrapperComponent;
    var wrapper = this.append(div({
        style: {
            height: "100%",
            display: "flex",
            alignItems: "stretch",
        },
    }));
    var navigation = wrapper.append(div({
        className: "navMenu", // TODO: styles
        style: { display: "flex", flexDirection: "column" },
    }));
    for (var _i = 0, routes_2 = routes; _i < routes_2.length; _i++) {
        var route = routes_2[_i];
        if (route.showInNavigation) {
            navigation.append(span(route.label, { href: route.path }));
        }
    }
    // navigation.append() // TODO: divider()
    for (var _a = 0, MAIN_PAGE_SECTIONS_2 = MAIN_PAGE_SECTIONS; _a < MAIN_PAGE_SECTIONS_2.length; _a++) {
        var section = MAIN_PAGE_SECTIONS_2[_a];
        navigation.append(span(section.label, { href: "#".concat(section.id) }));
    }
    var contentWrapper = wrapper.append(contentWrapperComponent());
    contentWrapper.append(currentRoute.component());
});
renderRoot(root());
//# sourceMappingURL=docs.js.map